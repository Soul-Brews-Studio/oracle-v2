---
title: "Fix DocDetail Bug #4 + SidebarLayout + GitHub Link Fallback"
date: 2026-01-26
time: "07:57 GMT+7"
duration: ~2 hours
tags: [bug-fix, frontend, backend, indexer, security, data-loss]
---

# Session Retrospective: Fix DocDetail Bug #4

## What We Did

### 1. Fixed Bug #4: DocDetail Shows Truncated Content
- **Root cause**: `REPO_ROOT` defaulted to `~/.oracle-v2` instead of project root
- **Fix**: Auto-detect project root if `ψ/` directory exists
- Added `/api/doc/:id` endpoint for direct document fetch by ID
- Simplified `DocDetail.loadDoc()` to use `getDoc()` API
- Removed 500-char content truncation from all handlers

### 2. Created Reusable SidebarLayout Component
- Extracted sidebar from Feed.tsx into shared component
- Both Feed and DocDetail now use SidebarLayout
- Consistent "Filter by Type" sidebar across pages

### 3. File Path Link → Plain Text + GitHub Fallback
- `/api/file` now returns plain text (not JSON)
- File path in footer is clickable link to raw content
- Security: Path traversal attacks blocked (tested)
- When local file not found + project exists → Show GitHub link

### 4. Store Project (ghq path) with Documents
- Indexer detects project from repoRoot: `github.com/owner/repo`
- Stores in `oracle_documents.project` field
- Enables GitHub fallback: `https://github.com/owner/repo/blob/main/path`

### 5. Fixed Indexer to Handle Missing Directories
- Added `fs.existsSync()` check before reading resonance directory
- Prevents crash when ψ/memory/resonance doesn't exist

## Commits Made

| Hash | Description |
|------|-------------|
| `b3c537a` | fix: DocDetail shows full content, direct URL access works |
| `888a953` | feat: Add SidebarLayout, file path link, plain text /api/file |
| `15235e7` | feat: Store project (ghq path) with documents, show GitHub link |

## Data Loss Incident

**What happened**: Indexer clears DB before each run. Re-indexing from Nat-s-Agents overwrote previous data including MCP-added learnings that only existed in DB (not files).

**Lost**: ~4000+ learnings added via `oracle_learn` MCP tool

**Recovery attempted**: Time Machine backups exist but require sudo to mount

**Prevention needed**:
- Add `--append` mode to indexer (don't clear)
- Or backup before clearing
- Or store MCP learnings as files too

## Key Files Changed

```
src/server/db.ts          - Auto-detect REPO_ROOT from ψ/ directory
src/server.ts             - Added /api/doc/:id, plain text /api/file
src/server/handlers.ts    - Removed content truncation
src/indexer.ts            - Store project field, handle missing dirs
frontend/src/components/SidebarLayout.tsx    - New shared component
frontend/src/pages/DocDetail.tsx             - Use SidebarLayout, GitHub link
frontend/src/pages/Feed.tsx                  - Use SidebarLayout
```

## Lessons Learned

1. **Indexer clears DB** - dangerous for MCP-added data that's not in files
2. **ghq convention** enables elegant multi-repo support: `~/Code/github.com/owner/repo`
3. **Project field** allows GitHub fallback when local file not found
4. **Path traversal security** - always verify resolved path is within bounds

## AI Diary

Started with a simple bug fix (#4 DocDetail truncation), which led down a rabbit hole of improvements. The fix required understanding the dual database architecture (Drizzle ORM + raw bun:sqlite), the shared `~/.oracle-v2/oracle.db` across repos, and the path resolution flow.

The sidebar addition was user-requested enhancement that improved UX consistency. The GitHub link fallback was a creative solution to the "file not found" problem when documents are indexed from different repos.

The data loss was painful but instructive. The indexer's "clear before index" behavior is dangerous when knowledge can come from both files AND MCP tools. This needs architectural consideration.

## Honest Feedback

**What worked well**:
- Incremental fixes, testing after each change
- Security testing for path traversal
- ghq convention insight for multi-repo support

**What could be better**:
- Should have asked about backup before running indexer
- Data loss could have been prevented with more caution
- Too many changes in one session - hard to track

## Next Session

- [ ] Restore oracle.db from Time Machine backup (manual via Finder)
- [ ] Add `--append` flag to indexer to prevent data loss
- [ ] Consider storing MCP learnings as files (Nothing is Deleted)
- [ ] Push commits to origin
- [ ] Close issue #4

---
*Session ended: 2026-01-26 07:57 GMT+7*
